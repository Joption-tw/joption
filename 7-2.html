<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>雙賣動態平衡模擬器 | 歐大選擇權教室</title>
    
    <!-- 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 引入 Babel 用於解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { margin: 0; padding: 0; background-color: #f8fafc; overflow-x: hidden; }
        .wood-texture {
            background-color: #8B4513;
            background-image: linear-gradient(45deg, rgba(255, 255, 255, 0.1) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0.1) 75%, transparent 75%, transparent);
            background-size: 20px 20px;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .pop-card {
            border: 3px solid #0F172A;
            box-shadow: 6px 6px 0px #0F172A;
        }
        @media (min-width: 768px) {
            .pop-card {
                border-width: 4px;
                box-shadow: 10px 10px 0px #0F172A;
            }
        }
        .no-select {
            user-select: none;
            -webkit-user-select: none;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- 圖示組件 ---
        const SeesawLogo = ({ size = 48, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" className={className}>
                <rect width="64" height="64" rx="16" fill="#EFF6FF"/>
                <path d="M32 50L26 58H38L32 50Z" fill="#4B5563"/>
                <rect x="12" y="46" width="40" height="4" rx="2" fill="#1F2937" transform="rotate(-5 32 48)"/>
                <circle cx="16" cy="42" r="6" fill="#EF4444" transform="rotate(-5 32 48)" stroke="white" strokeWidth="2"/>
                <circle cx="48" cy="42" r="6" fill="#10B981" transform="rotate(-5 32 48)" stroke="white" strokeWidth="2"/>
            </svg>
        );

        const MarketUpIcon = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="m18 15-6-6-6 6"/></svg>
        );

        const MarketDownIcon = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>
        );

        // --- 輔助函數 ---
        const fmt = (num) => new Intl.NumberFormat('zh-TW').format(Math.round(num));

        const calculatePremium = (type, strike, spotPrice) => {
            const distance = type === 'call' ? spotPrice - strike : strike - spotPrice;
            const k = 350000; 
            const price = (distance + Math.sqrt(distance * distance + k)) / 2;
            return Math.round(price);
        };

        const App = () => {
            // 風控條件
            const [balanceMin, setBalanceMin] = useState(40);
            const [balanceMax, setBalanceMax] = useState(60);
            const [marginThreshold, setMarginThreshold] = useState(500000);

            const [spotPrice, setSpotPrice] = useState(30000);
            const [totalEquity, setTotalEquity] = useState(5000000); 
            
            const [positions, setPositions] = useState([
                { id: 1, type: 'put', strike: 29900, quantity: 20 }, 
                { id: 2, type: 'call', strike: 30100, quantity: 20 }, 
            ]);

            const [logs, setLogs] = useState([]);

            const portfolioStatus = useMemo(() => {
                let callTotalPoints = 0;
                let putTotalPoints = 0;
                let currentMarginUsed = 0;

                const calculatedPositions = positions.map(pos => {
                    const currentPrice = calculatePremium(pos.type, pos.strike, spotPrice);
                    const totalPoints = currentPrice * pos.quantity;
                    // 更新：保證金改為一口 100,000
                    const marginPerUnit = 100000; 
                    currentMarginUsed += marginPerUnit * pos.quantity;
                    if (pos.type === 'call') callTotalPoints += totalPoints;
                    if (pos.type === 'put') putTotalPoints += totalPoints;
                    return { ...pos, currentPrice, totalPoints };
                });

                const totalPoints = callTotalPoints + putTotalPoints;
                const balanceRatio = totalPoints === 0 ? 50 : (callTotalPoints / totalPoints) * 100;
                const marginBalance = totalEquity - currentMarginUsed; 

                return { callTotalPoints, putTotalPoints, balanceRatio, calculatedPositions, currentMarginUsed, marginBalance };
            }, [positions, spotPrice, totalEquity]);

            const simulateMarketMove = (delta) => {
                setSpotPrice(prev => prev + delta);
                addLog(`指數${delta > 0 ? '上漲' : '下跌'} ${Math.abs(delta)} 點`);
            };

            const executeTrade = (type, strike, quantity, action) => {
                setPositions(prev => {
                    const existingIdx = prev.findIndex(p => p.type === type && p.strike === strike);
                    let newPositions = [...prev];
                    if (action === 'sell') {
                        if (existingIdx >= 0) { newPositions[existingIdx].quantity += quantity; } 
                        else { newPositions.push({ id: Date.now(), type, strike, quantity }); }
                        addLog(`賣出 ${type.toUpperCase()} ${strike} x ${quantity}口`);
                    } else {
                        if (existingIdx >= 0 && newPositions[existingIdx].quantity >= quantity) {
                            newPositions[existingIdx].quantity -= quantity;
                            if (newPositions[existingIdx].quantity === 0) { newPositions = newPositions.filter((_, idx) => idx !== existingIdx); }
                            addLog(`買回 ${type.toUpperCase()} ${strike} x ${quantity}口`);
                        }
                    }
                    return newPositions;
                });
            };

            const addLog = (msg) => {
                setLogs(prev => [{ time: new Date().toLocaleTimeString(), msg }, ...prev].slice(0, 5));
            };

            const resetSimulation = () => {
                setSpotPrice(30000);
                setPositions([
                    { id: 1, type: 'put', strike: 29900, quantity: 20 },
                    { id: 2, type: 'call', strike: 30100, quantity: 20 },
                ]);
                setLogs([]);
                addLog("模擬重置至 30000 點");
            };

            const advice = useMemo(() => {
                const { balanceRatio, marginBalance } = portfolioStatus;
                const hasCapital = marginBalance >= marginThreshold;
                if (balanceRatio >= balanceMin && balanceRatio <= balanceMax) return { text: "目前處於平衡狀態", color: "text-green-600", bg: "bg-green-50" };
                if (balanceRatio < balanceMin) return { text: hasCapital ? "建議：Sell Call (增加左側重量)" : "建議：Buy Put (減少右側重量)", color: "text-red-600", bg: "bg-red-50" };
                return { text: hasCapital ? "建議：Sell Put (增加右側重量)" : "建議：Buy Call (減少左側重量)", color: "text-red-600", bg: "bg-red-50" };
            }, [portfolioStatus, balanceMin, balanceMax, marginThreshold]);

            const rotationDegree = (50 - portfolioStatus.balanceRatio) * 0.5;
            const clampedRotation = Math.max(-25, Math.min(25, rotationDegree));

            return (
                <div className="max-w-6xl mx-auto p-3 sm:p-6 lg:p-10 space-y-6">
                    
                    {/* Header: 歐大品牌式膠囊 */}
                    <header className="flex flex-col md:flex-row items-center justify-between gap-6 bg-white p-6 pop-card rounded-3xl">
                        <div className="flex items-center gap-4">
                            <SeesawLogo size={56} />
                            <div>
                                <h1 className="text-xl sm:text-3xl font-black text-slate-900 tracking-tight">雙賣動態平衡模擬器</h1>
                            </div>
                        </div>

                        {/* 風控設定區 */}
                        <div className="flex flex-wrap items-center gap-4 justify-center md:justify-end border-t md:border-t-0 md:border-l border-slate-100 pt-4 md:pt-0 md:pl-6">
                            <div className="flex items-center gap-2 bg-slate-50 p-2 rounded-xl border border-slate-200">
                                <span className="text-[10px] font-black text-slate-400 uppercase">平衡係數</span>
                                <input type="number" value={balanceMin} onChange={e => setBalanceMin(parseInt(e.target.value))} className="w-10 bg-transparent text-center font-bold font-mono outline-none"/>
                                <span className="text-slate-300">~</span>
                                <input type="number" value={balanceMax} onChange={e => setBalanceMax(parseInt(e.target.value))} className="w-10 bg-transparent text-center font-bold font-mono outline-none"/>
                                <span className="text-slate-400 font-bold text-[10px]">%</span>
                            </div>
                            <div className="flex items-center gap-2 bg-amber-50 p-2 rounded-xl border border-amber-100">
                                <span className="text-[10px] font-black text-amber-600 uppercase">保證金水位</span>
                                <input type="text" value={fmt(marginThreshold)} onChange={e => setMarginThreshold(parseInt(e.target.value.replace(/,/g,'')) || 0)} className="w-24 bg-transparent text-center font-bold font-mono outline-none text-amber-900"/>
                            </div>
                        </div>
                    </header>

                    {/* 主要內容 */}
                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        
                        {/* 左側：市場與帳戶 */}
                        <div className="lg:col-span-4 space-y-6">
                            <div className="pop-card bg-white p-6 rounded-3xl space-y-6">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-sm font-black text-slate-400 uppercase tracking-widest">市場狀態</h2>
                                    <button onClick={resetSimulation} className="text-[10px] font-black bg-slate-100 px-3 py-1 rounded-full text-slate-500 hover:bg-slate-200 uppercase tracking-tighter transition">重置模擬器</button>
                                </div>
                                <div className="text-center py-6 bg-slate-900 rounded-2xl">
                                    <div className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">台指期當前點數</div>
                                    <div className="text-5xl font-black text-white font-mono mt-1">{fmt(spotPrice)}</div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => simulateMarketMove(50)} className="flex items-center justify-center gap-2 py-4 bg-blue-50 text-blue-700 rounded-2xl border-2 border-blue-200 font-black hover:bg-blue-100 active:scale-95 transition-all">
                                        <MarketUpIcon /> 漲 50 點
                                    </button>
                                    <button onClick={() => simulateMarketMove(-50)} className="flex items-center justify-center gap-2 py-4 bg-red-50 text-red-700 rounded-2xl border-2 border-red-200 font-black hover:bg-red-100 active:scale-95 transition-all">
                                        <MarketDownIcon /> 跌 50 點
                                    </button>
                                </div>
                                <div className="space-y-3 pt-4 border-t border-slate-50">
                                    <div className="flex justify-between text-sm">
                                        <span className="font-bold text-slate-400 uppercase">帳戶總權益</span>
                                        <span className="font-mono font-black">{fmt(totalEquity)}</span>
                                    </div>
                                    <div className="flex justify-between text-sm">
                                        <span className="font-bold text-slate-400 uppercase text-xs">已用保證金 (10萬/口)</span>
                                        <span className="font-mono font-black text-orange-600">{fmt(portfolioStatus.currentMarginUsed)}</span>
                                    </div>
                                    <div className="flex justify-between text-sm">
                                        <span className="font-bold text-slate-400 uppercase">保證金餘額</span>
                                        <span className={`font-mono font-black ${portfolioStatus.marginBalance < marginThreshold ? 'text-red-500' : 'text-blue-600'}`}>
                                            {fmt(portfolioStatus.marginBalance)}
                                        </span>
                                    </div>
                                    <div className="w-full bg-slate-100 h-2.5 rounded-full overflow-hidden">
                                        <div 
                                            className={`h-full transition-all duration-700 ${portfolioStatus.marginBalance < marginThreshold ? 'bg-red-500' : 'bg-blue-500'}`} 
                                            style={{ width: `${Math.max(0, Math.min(100, (portfolioStatus.marginBalance / totalEquity) * 100))}%` }}
                                        ></div>
                                    </div>
                                </div>
                            </div>

                            <div className={`${advice.bg} p-6 rounded-3xl border-2 border-dashed ${advice.color.replace('text','border')} text-center shadow-sm`}>
                                <div className="text-[10px] font-black uppercase mb-1 opacity-50 tracking-widest">策略建議</div>
                                <div className={`text-base sm:text-lg font-black ${advice.color}`}>{advice.text}</div>
                            </div>
                        </div>

                        {/* 右側：平衡監控與明細 */}
                        <div className="lg:col-span-8 space-y-6">
                            <div className="pop-card bg-white p-6 rounded-3xl flex flex-col items-center">
                                <div className="w-full flex justify-between items-center mb-8">
                                    <h2 className="text-sm font-black text-slate-400 uppercase tracking-widest">平衡監控視窗</h2>
                                    <div className={`px-4 py-1 rounded-full text-[10px] font-black uppercase tracking-widest ${advice.text.includes('平衡') ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                        {advice.text.includes('平衡') ? '穩定狀態' : '失衡狀態'}
                                    </div>
                                </div>

                                <div className="flex w-full justify-between items-end px-4 sm:px-12 mb-10">
                                    <div className="text-center w-1/3">
                                        <div className="text-2xl sm:text-4xl font-black text-red-600 font-mono">{fmt(portfolioStatus.callTotalPoints)}</div>
                                        <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1">Call Points</div>
                                    </div>
                                    <div className="text-center w-1/3 border-b-4 border-slate-900 pb-2">
                                        <div className="text-3xl sm:text-6xl font-black text-slate-900 font-mono">{portfolioStatus.balanceRatio.toFixed(1)}%</div>
                                        <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1">Balance Ratio</div>
                                    </div>
                                    <div className="text-center w-1/3">
                                        <div className="text-2xl sm:text-4xl font-black text-green-600 font-mono">{fmt(portfolioStatus.putTotalPoints)}</div>
                                        <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1">Put Points</div>
                                    </div>
                                </div>

                                {/* 蹺蹺板視覺組件 */}
                                <div className="relative w-full h-40 flex flex-col items-center justify-center overflow-hidden">
                                    <div className="absolute bottom-4 w-0 h-0 border-l-[20px] border-l-transparent border-r-[20px] border-r-transparent border-b-[45px] border-b-slate-700"></div>
                                    <div 
                                        className="w-4/5 sm:w-2/3 h-4 wood-texture rounded-full shadow-lg transition-transform duration-1000 ease-out z-10" 
                                        style={{ transform: `rotate(${clampedRotation}deg)`, transformOrigin: 'center center' }}
                                    >
                                        <div className="absolute -top-10 sm:-top-14 left-0 flex flex-col items-center">
                                            <div className="px-3 py-2 sm:px-6 sm:py-4 bg-red-500 text-white rounded-xl shadow-md font-black text-[10px] sm:text-xs uppercase border-b-4 border-red-800">Call</div>
                                        </div>
                                        <div className="absolute -top-10 sm:-top-14 right-0 flex flex-col items-center">
                                            <div className="px-3 py-2 sm:px-6 sm:py-4 bg-green-500 text-white rounded-xl shadow-md font-black text-[10px] sm:text-xs uppercase border-b-4 border-green-800">Put</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* 持倉明細表 */}
                            <div className="pop-card bg-white p-6 rounded-3xl">
                                <h3 className="text-sm font-black text-slate-400 uppercase tracking-widest mb-4">當前持倉清單</h3>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left">
                                        <thead className="text-[10px] font-black text-slate-400 uppercase border-b border-slate-100">
                                            <tr>
                                                <th className="py-3 px-2">合約類型</th>
                                                <th className="py-3 px-2">履約價</th>
                                                <th className="py-3 px-2">口數</th>
                                                <th className="py-3 px-2">權利金</th>
                                                <th className="py-3 px-2">總點數</th>
                                                <th className="py-3 px-2 text-center">調整持倉</th>
                                            </tr>
                                        </thead>
                                        <tbody className="text-sm font-bold divide-y divide-slate-50">
                                            {portfolioStatus.calculatedPositions.map(pos => (
                                                <tr key={pos.id} className="hover:bg-slate-50 transition">
                                                    <td className={`py-4 px-2 font-black ${pos.type === 'call' ? 'text-red-500' : 'text-green-600'}`}>Sell {pos.type.toUpperCase()}</td>
                                                    <td className="py-4 px-2 font-mono">{pos.strike}</td>
                                                    <td className="py-4 px-2 font-mono">{pos.quantity}</td>
                                                    <td className="py-4 px-2 font-mono text-slate-400">{pos.currentPrice}</td>
                                                    <td className="py-4 px-2 font-black text-slate-900">{fmt(pos.totalPoints)}</td>
                                                    <td className="py-4 px-2 text-center">
                                                        <div className="flex items-center justify-center gap-2">
                                                            <button onClick={() => executeTrade(pos.type, pos.strike, 1, 'sell')} className="w-8 h-8 rounded-lg bg-green-100 text-green-700 flex items-center justify-center border border-green-200 hover:bg-green-200 transition active:scale-90">+</button>
                                                            <button onClick={() => executeTrade(pos.type, pos.strike, 1, 'buy')} className="w-8 h-8 rounded-lg bg-red-100 text-red-700 flex items-center justify-center border border-red-200 hover:bg-red-200 transition active:scale-90">-</button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* 操作紀錄 */}
                    <footer className="pop-card bg-slate-900 p-6 rounded-3xl text-white">
                        <h2 className="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] mb-4">交易日誌 / Transaction Log</h2>
                        <div className="space-y-2 h-32 overflow-y-auto pr-4 custom-scrollbar">
                            {logs.length === 0 && <p className="text-slate-700 italic text-sm py-4">等待系統操作中...</p>}
                            {logs.map((log, i) => (
                                <div key={i} className="flex gap-4 text-sm animate-in slide-in-from-left duration-300">
                                    <span className="font-mono text-slate-500 opacity-50">[{log.time}]</span>
                                    <span className="font-bold tracking-wide">{log.msg}</span>
                                </div>
                            ))}
                        </div>
                    </footer>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>